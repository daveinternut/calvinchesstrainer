# Lichess Flutter Packages — Reference for Calvin Chess Trainer

Two packages from the lichess.org team provide everything we need for chess UI and logic. They are designed to work together: **chessground** handles the board widget, and **dartchess** handles all chess rules/logic.

> **Current status**: We are not using either package yet. Our `pubspec.yaml` declares `chess: ^0.8.1` (a different, older package) which is imported nowhere. Our board is a fully custom widget. Both packages below should replace our custom code.

---

## Package Overview

| Package | Version | Purpose | License |
|---|---|---|---|
| [`chessground`](https://pub.dev/packages/chessground) | 8.0.1 | Chess board UI widget (rendering, interaction, animation) | GPL-3.0 |
| [`dartchess`](https://pub.dev/packages/dartchess) | 0.12.1 | Chess logic (legal moves, FEN/PGN, game state, variants) | GPL-3.0 |

**Note**: `chessground` depends on `dartchess`, so adding chessground automatically brings in dartchess.

**Platform support**: Android, iOS, Linux, macOS, Windows (not web for dartchess).

---

## chessground — Board UI Widget

### Installation

```yaml
dependencies:
  chessground: ^8.0.1
```

Also requires `fast_immutable_collections` (pulled in transitively).

### Core Classes

#### `Chessboard` — The main interactive board widget

```dart
import 'package:chessground/chessground.dart';
import 'package:dartchess/dartchess.dart';

// Static (non-interactive) board — great for display-only contexts
Chessboard.fixed(
  size: screenWidth,
  orientation: Side.white,
  fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR',
)

// Interactive board — for gameplay
Chessboard(
  size: screenWidth,
  orientation: Side.white,
  fen: position.fen,
  lastMove: lastMove,            // highlights the from/to squares
  settings: settings,            // ChessboardSettings object
  game: GameData(...),           // required for interactivity
  shapes: shapes,                // optional arrows/circles drawn on board
  annotations: annotations,      // optional move annotations
  squareHighlights: highlights,  // custom square coloring
  onTouchedSquare: (square) {},  // callback for any square touch
)
```

**Constructor parameters**:

| Parameter | Type | Description |
|---|---|---|
| `size` | `double` | Board size in logical pixels |
| `orientation` | `Side` | Which side faces the bottom (Side.white or Side.black) |
| `fen` | `String` | FEN string for piece positions |
| `lastMove` | `Move?` | Last move played (highlights from/to squares) |
| `game` | `GameData?` | Game state + callbacks for interactivity (null = non-interactive) |
| `settings` | `ChessboardSettings` | Visual/behavior configuration |
| `shapes` | `ISet<Shape>?` | Arrows and circles drawn on the board |
| `annotations` | `IMap<Square, Annotation>?` | Move annotations on squares |
| `squareHighlights` | `IMap<Square, HighlightDetails>` | Custom square highlighting |
| `onTouchedSquare` | `void Function(Square)?` | Fires when any square is touched |
| `opponentsPiecesUpsideDown` | `bool` | Rotate opponent pieces 180 degrees |

**Key properties**:
- `squareSize` — computed size of one square (board size / 8, minus border)
- `interactive` — whether the board accepts moves
- `offsetSquare(Offset)` — convert a screen offset to a Square
- `squareOffset(Square)` — convert a Square to a screen offset

#### `Chessboard.fixed` — Non-interactive board

Same as `Chessboard` but without `game` parameter. Good for:
- Board thumbnails
- Position display
- Our file/rank trainer (display-only with tap handling via `onTouchedSquare`)

#### `GameData` — Interactive game state

Provides the game state and callbacks that make the board playable.

```dart
GameData(
  playerSide: PlayerSide.white,        // who can interact
  sideToMove: Side.white,              // whose turn it is
  validMoves: makeLegalMoves(position),// IMap<Square, ISet<Square>>
  isCheck: position.isCheck,           // highlights king in check
  promotionMove: promotionMove,        // pending promotion (shows selector)
  onMove: (Move move, {bool? viaDragAndDrop}) {
    // Handle the move
  },
  onPromotionSelection: (Role? role) {
    // Handle promotion piece choice (null = cancelled)
  },
  premovable: (                        // optional premove support
    onSetPremove: (Move? move) {},
    premove: currentPremove,
  ),
)
```

**`PlayerSide` enum**:
- `PlayerSide.white` — only white can move
- `PlayerSide.black` — only black can move
- `PlayerSide.both` — both sides can move (free play / analysis)

**`ValidMoves` type**: `IMap<Square, ISet<Square>>` — maps each origin square to its legal destination squares. Generated by `makeLegalMoves()` from dartchess.

#### `ChessboardSettings` — Visual configuration

```dart
ChessboardSettings(
  // Appearance
  colorScheme: ChessboardColorScheme.brown,  // board theme
  pieceAssets: PieceSet.cburnett.assets,      // piece graphics
  border: BoardBorder(width: 16.0, color: Colors.brown),
  borderRadius: BorderRadius.circular(4),
  boxShadow: [BoxShadow(...)],
  brightness: 1.0,                           // 0.0-2.0
  hue: 0.0,                                  // 0.0-360.0 degrees
  enableCoordinates: true,                   // show a-h, 1-8 labels

  // Behavior
  animationDuration: Duration(milliseconds: 250),
  showLastMove: true,                        // highlight last move squares
  showValidMoves: true,                      // show destination dots
  blindfoldMode: false,                      // hide all pieces
  pieceShiftMethod: PieceShiftMethod.either, // drag, tap, or either
  dragFeedbackScale: 2.0,                    // enlarge piece while dragging
  dragFeedbackOffset: Offset(0.0, -1.0),     // offset dragged piece
  dragTargetKind: DragTargetKind.circle,     // circle or square highlight

  // Piece orientation
  pieceOrientationBehavior: PieceOrientationBehavior.facingUser,

  // Promotion
  autoQueenPromotion: false,                 // auto-promote to queen
  autoQueenPromotionOnPremove: true,

  // Drawing
  drawShape: DrawShapeOptions(
    enable: true,
    onCompleteShape: (Shape shape) {},
    onClearShapes: () {},
  ),

  // Variants
  enablePremoveCastling: true,
  enableDropMoves: false,                    // for Crazyhouse
)
```

#### `ChessboardEditor` — Position editor widget

For creating/editing positions (like lichess.org/editor). Pieces can be freely dragged on/off the board.

```dart
ChessboardEditor(
  size: screenWidth,
  orientation: Side.white,
  pieces: pieces,                         // Map<Square, Piece>
  pointerMode: EditorPointerMode.drag,    // drag or edit mode
  settings: ChessboardSettings(...),
  squareHighlights: highlights,
  onEditedSquare: (Square square) {},     // square tapped in edit mode
  onDroppedPiece: (Square? origin, Square destination, Piece piece) {},
  onDiscardedPiece: (Square square) {},   // piece dragged off board
)
```

### Available Piece Sets (PieceSet enum)

All piece sets from lichess, bundled as assets in the package:

| Value | Label | | Value | Label |
|---|---|---|---|---|
| `cburnett` | Colin M.L. Burnett | | `merida` | Merida |
| `pirouetti` | Pirouetti | | `chessnut` | Chessnut |
| `chess7` | Chess7 | | `alpha` | Alpha |
| `reillycraig` | Reillycraig | | `companion` | Companion |
| `riohacha` | Riohacha | | `kosal` | Kosal |
| `leipzig` | Leipzig | | `fantasy` | Fantasy |
| `spatial` | Spatial | | `celtic` | Celtic |
| `california` | California | | `caliente` | Caliente |
| `pixel` | Pixel | | `firi` | Firi |
| `rhosgfx` | RhosGFX | | `maestro` | Maestro |
| `fresca` | Fresca | | `cardinal` | Cardinal |
| `gioco` | Gioco | | `tatiana` | Tatiana |
| `staunty` | Staunty | | `governor` | Governor |
| `dubrovny` | Dubrovny | | `icpieces` | Icpieces |

Usage: `PieceSet.cburnett.assets` returns `PieceAssets` (IMap of PieceKind to asset data).

### Available Board Themes (ChessboardColorScheme constants)

| Theme | | Theme | | Theme |
|---|---|---|---|---|
| `brown` | | `blue` | | `blue2` |
| `blue3` | | `blueMarble` | | `canvas` |
| `green` | | `greenPlastic` | | `grey` |
| `horsey` | | `ic` | | `leather` |
| `maple` | | `maple2` | | `marble` |
| `metal` | | `newspaper` | | `olive` |
| `pinkPyramid` | | `purple` | | `purpleDiag` |
| `wood` | | `wood2` | | `wood3` |
| `wood4` | | | | |

Each provides: `lightSquare`, `darkSquare`, `background`, `whiteCoordBackground`, `blackCoordBackground`, `lastMove`, `selected`, `validMoves`, `validPremoves`.

### Shapes (drawn on board)

```dart
// Arrow from e2 to e4
Arrow(color: Colors.green, orig: Square.e2, dest: Square.e4)

// Circle on d5
Circle(color: Colors.red, orig: Square.d5)

// Piece shape (display a piece icon at a square as an overlay)
PieceShape(color: Colors.blue, orig: Square.f3, role: Role.knight)
```

### Utility Functions

| Function | Description |
|---|---|
| `readFen(String fen)` | Parse board part of FEN into `Pieces` (Map<Square, Piece>) |
| `writeFen(Pieces pieces)` | Convert `Pieces` back to FEN board string |
| `premovesOf(Square, Pieces, {canCastle})` | Get possible premove destinations |

---

## dartchess — Chess Logic Engine

### Installation

```yaml
dependencies:
  dartchess: ^0.12.1
```

### Core Classes

#### `Chess` — Standard chess position

```dart
// Initial position
final pos = Chess.initial;

// From FEN
final pos = Chess.fromSetup(Setup.parseFen(
  'rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1'
));

// Key properties
pos.turn             // Side.white or Side.black
pos.board            // Board object with piece positions
pos.fen              // Full FEN string
pos.isCheck          // bool
pos.isCheckmate      // bool
pos.isStalemate      // bool
pos.isGameOver       // bool
pos.isInsufficientMaterial // bool
pos.outcome          // Outcome? (null if game not over)
pos.legalMoves       // IMap<Square, SquareSet> — all legal moves
pos.halfmoves        // int — half-move clock
pos.fullmoves        // int — full move counter
pos.checkers         // SquareSet — squares giving check
pos.hasSomeLegalMoves // bool
```

#### `Position` — Base class (abstract)

All chess variant classes extend `Position`. Key methods:

**Move generation**:
```dart
pos.legalMoves                    // All legal moves: IMap<Square, SquareSet>
pos.legalMovesOf(Square.e2)       // Legal moves for one piece: SquareSet
pos.hasSomeLegalMoves             // Quick check: any legal moves?
pos.legalDrops                    // Legal drop squares (Crazyhouse)
```

**Move execution**:
```dart
pos.play(move)                    // Play a move (throws if illegal)
pos.playUnchecked(move)           // Play without legality check (faster)
pos.isLegal(move)                 // Check if a move is legal
```

**SAN (Standard Algebraic Notation)**:
```dart
pos.toSan(move)                   // Convert Move to SAN string (e.g. "Nf3")
pos.parseSan("Nf3")              // Parse SAN string to Move?
pos.makeSan(move)                 // Returns (newPosition, sanString)
pos.makeSanUnchecked(move)        // Same but skips legality check
```

**Game state detection**:
```dart
pos.isCheck                       // King in check?
pos.isCheckmate                   // Checkmate?
pos.isStalemate                   // Stalemate?
pos.isGameOver                    // Game over (any reason)?
pos.isInsufficientMaterial        // Draw by insufficient material?
pos.hasInsufficientMaterial(side) // One side has insufficient material?
pos.outcome                       // Outcome? with winner field
pos.isVariantEnd                  // Variant-specific end condition?
pos.variantOutcome                // Variant-specific outcome
```

**Position manipulation**:
```dart
pos.copyWith(board: ..., turn: ...) // Create modified copy
pos.validate()                      // Throws if position is illegal
```

#### `Move` — Represents a chess move

```dart
// Normal move (from square to square, optional promotion)
NormalMove(from: Square.e2, to: Square.e4)
NormalMove(from: Square.e7, to: Square.e8, promotion: Role.queen)

// From UCI format
NormalMove.fromUci('e2e4')
NormalMove.fromUci('e7e8q')  // with promotion

// Drop move (Crazyhouse)
DropMove(role: Role.pawn, to: Square.e4)

// Properties
move.from       // origin square
move.to         // destination square
move.promotion  // Role? — promotion piece
move.uci        // UCI string representation

// Modify
move.withPromotion(Role.queen)
```

#### `Square` — Board square representation

```dart
// Named constants for all 64 squares
Square.a1, Square.a2, ..., Square.h8

// Properties
square.file      // File (0-7)
square.rank      // Rank (0-7)
square.name      // String like "e4"
square.color     // SquareColor.light or SquareColor.dark

// From name
Square.fromName('e4')  // returns Square?
```

#### `File` and `Rank` — Extension types

```dart
File.a, File.b, ..., File.h  // File constants (0-7)
Rank.first, Rank.second, ..., Rank.eighth  // Rank constants (0-7)

file.name   // 'a' through 'h'
rank.name   // '1' through '8'
```

#### `Piece` — A chess piece

```dart
Piece(role: Role.king, color: Side.white)
Piece(role: Role.pawn, color: Side.black)

piece.role    // Role enum (king, queen, rook, bishop, knight, pawn)
piece.color   // Side enum (white, black)
piece.kind    // PieceKind enum (whiteKing, blackPawn, etc.)
piece.fenChar // 'K', 'q', etc.
```

#### `Board` — Piece positions

```dart
pos.board.pieceAt(Square.e1)      // Piece? at a square
pos.board.roleAt(Square.e1)       // Role? at a square
pos.board.sideAt(Square.e1)       // Side? at a square

pos.board.white                   // SquareSet of all white pieces
pos.board.black                   // SquareSet of all black pieces
pos.board.pawns                   // SquareSet of all pawns
pos.board.knights                 // SquareSet of all knights
pos.board.bishops                 // SquareSet of all bishops
pos.board.rooks                   // SquareSet of all rooks
pos.board.queens                  // SquareSet of all queens
pos.board.kings                   // SquareSet of all kings
pos.board.occupied                // SquareSet of all occupied squares
```

#### `SquareSet` — Bitboard operations

```dart
squareSet.squares              // Iterable<Square> of set squares
squareSet.isEmpty              // bool
squareSet.isNotEmpty           // bool
squareSet.first                // Square — first square in set
squareSet.last                 // Square — last square in set
squareSet.length               // int — number of squares
squareSet.contains(square)     // bool
```

#### `Setup` — Parse/write FEN

```dart
// Parse FEN
final setup = Setup.parseFen(
  'rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1'
);

// Create position from setup
final position = Chess.fromSetup(setup);

// Properties
setup.board           // Board
setup.turn            // Side
setup.castlingRights  // SquareSet
setup.epSquare        // Square?
setup.halfmoves       // int
setup.fullmoves       // int
```

#### `PgnGame` — PGN parsing and writing

```dart
// Parse PGN
final game = PgnGame.parsePgn(pgnString);
game.headers           // Map<String, String> (Event, Site, White, etc.)
game.moves             // PgnNode — move tree with comments/variations

// Write PGN
final pgn = game.makePgn();

// Traverse moves
game.moves.mainline()  // Iterable of PgnNodeData through the main line
```

### Top-Level Utility Functions

| Function | Returns | Description |
|---|---|---|
| `makeLegalMoves(pos)` | `IMap<Square, ISet<Square>>` | All legal moves in chessground-compatible format |
| `attacks(piece, square, occupied)` | `SquareSet` | Squares attacked by piece |
| `pawnAttacks(side, square)` | `SquareSet` | Pawn attack squares |
| `knightAttacks(square)` | `SquareSet` | Knight attack squares |
| `bishopAttacks(square, occupied)` | `SquareSet` | Bishop attack squares |
| `rookAttacks(square, occupied)` | `SquareSet` | Rook attack squares |
| `queenAttacks(square, occupied)` | `SquareSet` | Queen attack squares |
| `kingAttacks(square)` | `SquareSet` | King attack squares |
| `between(a, b)` | `SquareSet` | Squares between a and b (same rank/file/diag) |
| `ray(a, b)` | `SquareSet` | Full ray through a and b |
| `perft(pos, depth)` | `int` | Count legal move paths (testing) |

### Constants

| Constant | Value | Description |
|---|---|---|
| `kInitialFEN` | `'rnbqkbnr/ppp...'` | Starting position FEN |
| `kInitialBoardFEN` | `'rnbqkbnr/ppp...'` | Board-only part of initial FEN |
| `kEmptyFEN` | `'8/8/8/...'` | Empty board FEN |
| `kEmptyBoardFEN` | `'8/8/8/...'` | Board-only part of empty FEN |

### Variant Support

Dartchess supports these variants (all extend `Position`):

| Class | Variant |
|---|---|
| `Chess` | Standard chess |
| `Antichess` | Lose all your pieces to win |
| `Atomic` | Captures cause explosions |
| `Crazyhouse` | Drop captured pieces |
| `Horde` | White has 36 pawns |
| `KingOfTheHill` | King to center wins |
| `RacingKings` | Race kings to 8th rank |
| `ThreeCheck` | Three checks wins |

Each variant has `.initial` and `.fromSetup()` constructors and correctly implements its own `legalMoves`, `isGameOver`, `outcome`, etc.

### Error Handling

| Exception | When |
|---|---|
| `FenException` | Invalid FEN string |
| `PlayException` | Attempting an illegal move via `play()` |
| `PositionSetupException` | Illegal position setup |

---

## Integration Pattern — How They Work Together

The standard pattern for a playable board (from the chessground example app):

```dart
import 'package:chessground/chessground.dart';
import 'package:dartchess/dartchess.dart';

class GameScreen extends StatefulWidget { ... }

class _GameScreenState extends State<GameScreen> {
  // dartchess handles all game logic
  Position position = Chess.initial;
  String fen = kInitialBoardFEN;
  Move? lastMove;
  ValidMoves validMoves = makeLegalMoves(Chess.initial);
  NormalMove? promotionMove;

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    return Chessboard(
      size: screenWidth,
      orientation: Side.white,
      fen: fen,
      lastMove: lastMove,
      settings: const ChessboardSettings(
        pieceAssets: PieceSet.cburnett.assets,
        colorScheme: ChessboardColorScheme.brown,
        enableCoordinates: true,
        animationDuration: Duration(milliseconds: 250),
      ),
      game: GameData(
        playerSide: PlayerSide.white,
        sideToMove: position.turn == Side.white ? Side.white : Side.black,
        validMoves: validMoves,
        isCheck: position.isCheck,
        promotionMove: promotionMove,
        onMove: _onMove,
        onPromotionSelection: _onPromotion,
      ),
    );
  }

  void _onMove(Move move, {bool? viaDragAndDrop}) {
    if (move is NormalMove && _isPromotionMove(move)) {
      setState(() => promotionMove = move);
    } else if (position.isLegal(move)) {
      setState(() {
        position = position.playUnchecked(move);
        lastMove = move;
        fen = position.fen;
        validMoves = makeLegalMoves(position);
      });
    }
  }

  void _onPromotion(Role? role) {
    if (role != null && promotionMove != null) {
      _onMove(promotionMove!.withPromotion(role));
    }
    setState(() => promotionMove = null);
  }

  bool _isPromotionMove(NormalMove move) {
    return move.promotion == null &&
        position.board.roleAt(move.from) == Role.pawn &&
        ((move.to.rank == Rank.first && position.turn == Side.black) ||
         (move.to.rank == Rank.eighth && position.turn == Side.white));
  }
}
```

---

## What These Packages Replace in Our Codebase

### Currently manual → Handled by chessground

| Our code | Replaced by |
|---|---|
| `ChessBoard` widget (175 lines) | `Chessboard` / `Chessboard.fixed` widget |
| Square color calculation (`isDarkSquare`) | Built into `ChessboardColorScheme` |
| File/rank label rendering | `enableCoordinates: true` in settings |
| SVG piece rendering | Built-in with 28 piece sets |
| Piece positioning from Map | FEN string input |
| Square highlight system | `squareHighlights` parameter |
| Tap handling | `onTouchedSquare` callback |
| Board flipping | `orientation: Side.black` |
| `board_state.dart` models | `HighlightDetails`, `Shape` classes |

### Currently not implemented → Handled by dartchess

| Planned feature | dartchess provides |
|---|---|
| Legal move generation (Move Trainer) | `pos.legalMoves`, `makeLegalMoves(pos)` |
| Move validation | `pos.isLegal(move)` |
| Move execution | `pos.play(move)`, `pos.playUnchecked(move)` |
| SAN notation parsing (Move Trainer) | `pos.parseSan("Nf3")`, `pos.toSan(move)` |
| FEN handling (Tactics Trainer puzzles) | `Setup.parseFen()`, `pos.fen` |
| PGN support | `PgnGame.parsePgn()`, `game.makePgn()` |
| Check/checkmate detection | `pos.isCheck`, `pos.isCheckmate` |
| Game over detection | `pos.isGameOver`, `pos.outcome` |
| Piece attack calculations | `attacks()`, `knightAttacks()`, etc. |

### Currently not implemented → Handled by chessground

| Planned feature | chessground provides |
|---|---|
| Drag-and-drop piece movement | `PieceShiftMethod.drag` / `.either` |
| Move destination dots | `showValidMoves: true` |
| Last move highlighting | `lastMove` parameter |
| Check highlighting | `isCheck` in `GameData` |
| Piece animation | `animationDuration` setting |
| Promotion UI | Built-in promotion selector |
| Drawing arrows/circles on board | `shapes` parameter + `DrawShapeOptions` |
| Blindfold mode | `blindfoldMode: true` |

---

## Migration Notes

### What we keep
- Our custom file/rank/square highlighting system for the trainers (can map onto `squareHighlights` + `onTouchedSquare`)
- Our Riverpod state management pattern
- Our audio system
- Our feature-based architecture

### What changes
1. Replace `chess: ^0.8.1` with `chessground: ^8.0.1` in pubspec.yaml (dartchess comes transitively)
2. Add `fast_immutable_collections` as explicit dependency (used pervasively by both packages)
3. Replace our `ChessBoard` widget with `Chessboard.fixed` for trainers, `Chessboard` for game modes
4. Replace our `board_state.dart` models with chessground's `HighlightDetails`
5. Remove `assets/images/pieces/` — chessground bundles all piece sets
6. Remove `flutter_svg` dependency (no longer needed for pieces)

### License consideration
Both packages are GPL-3.0. This means our app must also be GPL-3.0 licensed if we distribute it. For a kids' training app this is likely fine, but worth noting.

---

## Links

- chessground pub.dev: https://pub.dev/packages/chessground
- chessground API docs: https://pub.dev/documentation/chessground/latest/
- chessground GitHub: https://github.com/lichess-org/flutter-chessground
- chessground example app: https://pub.dev/packages/chessground/example
- dartchess pub.dev: https://pub.dev/packages/dartchess
- dartchess API docs: https://pub.dev/documentation/dartchess/latest/
- dartchess GitHub: https://github.com/lichess-org/dartchess
- All lichess.org packages: https://pub.dev/publishers/lichess.org/packages
